## Implementation approach

我们将基于FastAPI中间件机制实现trace_id的自动注入与传播，使用contextvars实现异步上下文管理，结合标准logging模块改造日志输出格式，自动附加trace信息。选用轻量级、零依赖方案，通过环境变量配置，支持JSON日志格式。性能埋点通过装饰器实现，可选集成Jaeger。目标是开箱即用、零侵入、高性能。

## File list

- main.py
- trace_middleware.py
- logger.py
- decorators.py
- config.py
- exporter.py

## Data structures and interfaces


classDiagram
    class TraceMiddleware {
        +__init__(app: FastAPI, enable_performance: bool = False)
        +__call__(scope: dict, receive: callable, send: callable) Awaitable[None]
    }
    class TraceContext {
        +trace_id: str
        +parent_span_id: str
        +start_time: float
        +spans: list[dict]
        +__init__()
        +new_span(name: str) dict
        +close_span(span: dict)
        +to_dict() dict
    }
    class TraceLogger {
        +__init__(logger_name: str = \"fastapi_trace\")
        +get_logger() logging.Logger
        +_trace_filter(record: logging.LogRecord) bool
    }
    class PerformanceDecorator {
        +trace_span(name: str) Callable
    }
    class Config {
        +TRACE_HEADER_NAME: str
        +LOG_FORMAT: str
        +ENABLE_JSON_LOG: bool
        +ENABLE_JAEGER: bool
        +JAEGER_HOST: str
        +JAEGER_PORT: int
        +__init__()
        +load_from_env()
    }
    class JaegerExporter {
        +__init__(config: Config)
        +export(trace_context: TraceContext)
    }
    TraceMiddleware --> TraceContext : creates and manages
    TraceLogger --> TraceContext : reads current context
    PerformanceDecorator --> TraceContext : updates spans
    JaegerExporter --> TraceContext : consumes
    TraceMiddleware --> Config : reads settings
    TraceLogger --> Config : reads LOG_FORMAT, ENABLE_JSON_LOG
    JaegerExporter --> Config : reads JAEGER_* settings


## Program call flow


sequenceDiagram
    participant Client as HTTP Client
    participant FastAPI as FastAPI App
    participant TM as TraceMiddleware
    participant TC as TraceContext
    participant TL as TraceLogger
    participant PD as PerformanceDecorator
    participant JE as JaegerExporter
    participant Config as Config
    Client->>FastAPI: HTTP Request (with/without trace header)
    FastAPI->>TM: __call__(scope, receive, send)
    TM->>Config: load settings
    TM->>TC: __init__()  # 创建TraceContext实例
    alt 请求含trace头
        TM->>TC: 使用传入trace_id
    else
        TM->>TC: 生成新trace_id
    end
    TM->>contextvars: 设置当前上下文
    TM->>FastAPI: 继续处理请求（路由/中间件）
    FastAPI->>PD: @trace_span('db_query')
    PD->>TC: new_span('db_query')
    PD->>FastAPI: 执行被装饰函数
    FastAPI-->>PD: 返回结果
    PD->>TC: close_span(span)
    FastAPI->>TL: logger.info('Processing user request')
    TL->>TC: 读取当前trace_id
    TL->>logging: 输出含trace_id的日志
    TM->>JE: 若启用且请求结束，export(trace_context)
    JE->>Jaeger: 发送span数据
    TM->>Client: 返回HTTP响应（含trace头）
    TM->>contextvars: 清理上下文


## Anything UNCLEAR

当前设计假设仅用于FastAPI单服务场景，不支持跨服务传播。如需支持分布式追踪（如HTTP头传播到下游服务），需扩展中间件以注入/提取标准协议头（如W3C Trace Context）。可视化UI需依赖Jaeger等外部系统，本项目仅提供导出接口。

